---
title: "MLOps"
description: "WSL 리눅스 배포"
date: today # 날짜 설정: now, last-modified
author:
  - name: 이광춘
    affiliation: TCS
title-block-banner: false
format:
  html:
    theme: 
      - flatly
      - css/quarto-fonts.css
    code-fold: true
    code-overflow: wrap
    toc: true
    toc-depth: 3
    number-sections: true
    highlight-style: pygments 
    self-contained: false
editor_options: 
  chunk_output_type: console
knitr:
  opts_chunk: 
    collapse: true
    comment: "#>" 
    R.options:
      knitr.graphics.auto_pdf: true  
filters:
   - lightbox
   - include-code-files
lightbox: auto      
---


# WSL 리눅스

윈도우에서 리눅스를 사용하는 방식은 진화를 거듭했지만 최근에는 Microsoft Store에서 `ubuntu` 리눅스를 앱 사용하듯이 설치해서 사용하면 된다.

[[데이터 과학 : 윈도우 10 - WSL (우분투 배쉬), 2019년 경](https://statkclee.github.io/data-science/ds-windows-bash.html)]{.aside}

![](fig/wsl_ubuntu.png)

## 로컬 디렉토리

`/mnt/` 디렉토리 아래 `C:\`, `D:\` 드라이브를 찾을 수 있고 그 아래 작업 디렉토리와 파일로 이동하면 후속 작업을 이어서 수행할 수 있다.

```bash
statkclee@dl:/mnt/d/tcs/curriculum/mlops$ cd /mnt/
statkclee@dl:/mnt$ ls
c  d  wsl
statkclee@dl:/mnt$ cd d/tcs/curriculum/mlops/
statkclee@dl:/mnt/d/tcs/curriculum/mlops$ pwd
/mnt/d/tcs/curriculum/mlops
```

![](fig/penguins-pip.png)

# 암수 기계학습 모형

파머 펭귄 데이터를 사용하여 Random Forest 기계학습 예측모형을 사용하여 성별 예측 기계학습 모형을 파이썬 `sk-learn`, `numpy`, `pandas` 패키지를 사용해서 구축해보자. 

```{r}
library(reticulate)

reticulate::source_python("mlops/vanilla/penguins.py")

py$accuracy
```

## 파이썬 코드

패키지 상단에 설치하고 파머펭귄 패키지 데이터를 가져와서 
결측값 제거하고 기계학습 관련 훈련/시험 데이터 나누고,
Random Forest 예측모형으로 성별 예측 모형 개발하고 시험데이터로 
성별 예측모형 정확도를 측정한다.

```{.python include="mlops/vanilla/penguins.py"}
```

## 실제 배포환경

개발환경에서 성별예측모형을 개발했지만 이를 배포하게 되면 배포될 컴퓨터에는 관련 패키지가 설치되어 있지 않다. 그렇다고 수작업으로 `requirements.txt` 파일에 관련 패키지를 수작업으로 일일이 넣을 수는 없다.

## `pipreqs` 패키지

`pipreqs` 패키지는 `pip freeze` 명령어와 비교하여 해당 프로젝트(디렉토리)의 
파이썬 패키지만 `requirements.txt` 파일에 담아낸다.

```bash
statkclee@dl:/mnt/d/tcs/curriculum/mlops/vanilla$ pip install pipreqs
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: pipreqs in /home/statkclee/.local/lib/python3.10/site-packages (0.4.11)
Requirement already satisfied: yarg in /home/statkclee/.local/lib/python3.10/site-packages (from pipreqs) (0.1.9)
Requirement already satisfied: docopt in /home/statkclee/.local/lib/python3.10/site-packages (from pipreqs) (0.6.2)
Requirement already satisfied: requests in /home/statkclee/.local/lib/python3.10/site-packages (from yarg->pipreqs) (2.28.2)
Requirement already satisfied: idna<4,>=2.5 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (3.4)
Requirement already satisfied: urllib3<1.27,>=1.21.1 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (1.26.14)
Requirement already satisfied: certifi>=2017.4.17 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (2022.12.7)
Requirement already satisfied: charset-normalizer<4,>=2 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (3.0.1)
```

## 패키지 설치

`pip install -r requirements.txt` 명령어로 암수성별 예측 기계학습모형 개발에 사용된
패키지를 일괄 설치할 수 있다.

```bash
statkclee@dl:/mnt/d/tcs/curriculum/mlops/vanilla$ pipreqs .
statkclee@dl:/mnt/d/tcs/curriculum/mlops/vanilla$ ls
penguins.py  requirements.txt

statkclee@dl:/mnt/d/tcs/curriculum/mlops/vanilla$ pip install -r requirements.txt
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: numpy==1.24.2 in /home/statkclee/.local/lib/python3.10/site-packages (from -r requirements.txt (line 1)) (1.24.2)
Collecting palmerpenguins==0.1.4
  Downloading palmerpenguins-0.1.4-py3-none-any.whl (17 kB)
Collecting pandas==1.5.3
  Downloading pandas-1.5.3-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (12.1 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 12.1/12.1 MB 11.3 MB/s eta 0:00:00
Collecting scikit_learn==1.2.1
  Downloading scikit_learn-1.2.1-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (9.6 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 9.6/9.6 MB 11.4 MB/s eta 0:00:00
Collecting pytz>=2020.1
  Downloading pytz-2022.7.1-py2.py3-none-any.whl (499 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 499.4/499.4 kB 10.3 MB/s eta 0:00:00
Collecting python-dateutil>=2.8.1
  Downloading python_dateutil-2.8.2-py2.py3-none-any.whl (247 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 247.7/247.7 kB 9.7 MB/s eta 0:00:00
Collecting scipy>=1.3.2
  Downloading scipy-1.10.1-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (34.4 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 34.4/34.4 MB 10.9 MB/s eta 0:00:00
Collecting joblib>=1.1.1
  Downloading joblib-1.2.0-py3-none-any.whl (297 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 298.0/298.0 kB 9.8 MB/s eta 0:00:00
Collecting threadpoolctl>=2.0.0
  Downloading threadpoolctl-3.1.0-py3-none-any.whl (14 kB)
Requirement already satisfied: six>=1.5 in /usr/lib/python3/dist-packages (from python-dateutil>=2.8.1->pandas==1.5.3->-r requirements.txt (line 3)) (1.16.0)
Installing collected packages: pytz, threadpoolctl, scipy, python-dateutil, joblib, scikit_learn, pandas, palmerpenguins
Successfully installed joblib-1.2.0 palmerpenguins-0.1.4 pandas-1.5.3 python-dateutil-2.8.2 pytz-2022.7.1 scikit_learn-1.2.1 scipy-1.10.1 threadpoolctl-3.1.0
```

## 실행

`python3 penguins.py` 명령어로 개발환경에서 제작한 암수성별 예측모형을 성공적으로 배포함을 확인할 수 있다.

```bash
statkclee@dl:/mnt/d/tcs/curriculum/mlops/vanilla$ python3 penguins.py
정확도(Accuracy): 0.835820895522388
```


# 파이프라인 기계학습

기계학습 파이프라인을 구축하여 암수성별 예측모형을 개발한다.

```{r}
library(reticulate)

reticulate::source_python("mlops/pipeline/penguins_pipeline.py")

py$accuracy
```

## 파이썬 코드

Feature Engineering과 예측모형을 `Pipeline()` 함수에 넣어 체계화한다.

```{.python include="mlops/pipeline/penguins_pipeline.py"}
```

## 실행

`python3 penguins_pipeline.py` 명령어로 개발환경에서 파이프라인 방식을 적용하여 제작한 암수성별 예측모형을 성공적으로 배포함을 확인할 수 있다.

```bash
statkclee@dl:/mnt/d/tcs/curriculum/mlops/pipeline$ python3 penguins_pipeline.py
파이프라인 방식 정확도(Accuracy): 0.8507462686567164
```

# 객체지향 기계학습

기계학습모형을 객체지향 클래스로 구축하여 암수성별 예측모형을 클래스로 개발하여 적용시킨다.

```{r}
library(reticulate)

reticulate::source_python("mlops/oop/penguins_oop.py")

py$accuracy
```

## 파이썬 코드

객체지향 `PenguinSexClassifier` 클래스를 생성하여 기계학습 예측모형을 제작할 수 있다.

```{.python include="mlops/oop/penguins_oop.py"}
```

## 실행

`python3 ` 명령어로 개발환경에서 객체지향 방식으로 개발한 클래스 방식을 적용하여 제작한 암수성별 예측모형을 성공적으로 배포함을 확인할 수 있다.

```bash
statkclee@dl:/mnt/d/tcs/curriculum/mlops/oop$ python3 penguins_oop.py
OOP 정확도(Accuracy): 0.8656716417910447
```

# `Makefile` 자동화

## 파이썬 파일

암수성별 예측모형 정확도를 텍스트 파일에 저장하는 로직을 추가한다.
이를 통해 `requirements.txt` 파일을 저장시킨다.

```{.python include="mlops/makefile/penguins_pipeline.py"}
```

## `Makefile`

자동화 대상을 다음과 같이 정리한다.

1. `make requirements` : 파이썬 패키지 설치 목록을 `requirements.txt` 에 작성한다.
1. `make install` : `requirements.txt` 파일에 저장된 패키지를 설치한다.
1. `make run` : 암수성별 예측모형을 실행하고 예측정확도를 `results.txt` 파일에 기록한다.

```{.python include="mlops/makefile/Makefile"}
```

## 작업 예시

```{bash}
#| eval: false
statkclee@dl:/mnt/d/tcs/curriculum/mlops/makefile$ make help
Usage: make [target]

Targets:
  help            Show this help message
  all              Install dependencies and run the script
  requirements  Generate requirements.txt using pipreqs
  install          Install dependencies
  run              Run the script
  clean          Clean up the project directory

statkclee@dl:/mnt/d/tcs/curriculum/mlops/makefile$ make requirements
pip3 install pipreqs
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: pipreqs in /home/statkclee/.local/lib/python3.10/site-packages (0.4.11)
Requirement already satisfied: docopt in /home/statkclee/.local/lib/python3.10/site-packages (from pipreqs) (0.6.2)
Requirement already satisfied: yarg in /home/statkclee/.local/lib/python3.10/site-packages (from pipreqs) (0.1.9)
Requirement already satisfied: requests in /home/statkclee/.local/lib/python3.10/site-packages (from yarg->pipreqs) (2.28.2)
Requirement already satisfied: urllib3<1.27,>=1.21.1 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (1.26.14)
Requirement already satisfied: charset-normalizer<4,>=2 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (3.0.1)
Requirement already satisfied: certifi>=2017.4.17 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (2022.12.7)
Requirement already satisfied: idna<4,>=2.5 in /home/statkclee/.local/lib/python3.10/site-packages (from requests->yarg->pipreqs) (3.4)
pipreqs --force .
INFO: Successfully saved requirements file in ./requirements.txt

statkclee@dl:/mnt/d/tcs/curriculum/mlops/makefile$ make install
pip3 install -r requirements.txt
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: numpy==1.24.2 in /home/statkclee/.local/lib/python3.10/site-packages (from -r requirements.txt (line 1)) (1.24.2)
Requirement already satisfied: palmerpenguins==0.1.4 in /home/statkclee/.local/lib/python3.10/site-packages (from -r requirements.txt (line 2)) (0.1.4)
Requirement already satisfied: pandas==1.5.3 in /home/statkclee/.local/lib/python3.10/site-packages (from -r requirements.txt (line 3)) (1.5.3)
Requirement already satisfied: scikit_learn==1.2.1 in /home/statkclee/.local/lib/python3.10/site-packages (from -r requirements.txt (line 4)) (1.2.1)
Requirement already satisfied: pytz>=2020.1 in /home/statkclee/.local/lib/python3.10/site-packages (from pandas==1.5.3->-r requirements.txt (line 3)) (2022.7.1)
Requirement already satisfied: python-dateutil>=2.8.1 in /home/statkclee/.local/lib/python3.10/site-packages (from pandas==1.5.3->-r requirements.txt (line 3)) (2.8.2)
Requirement already satisfied: scipy>=1.3.2 in /home/statkclee/.local/lib/python3.10/site-packages (from scikit_learn==1.2.1->-r requirements.txt (line 4)) (1.10.1)
Requirement already satisfied: joblib>=1.1.1 in /home/statkclee/.local/lib/python3.10/site-packages (from scikit_learn==1.2.1->-r requirements.txt (line 4)) (1.2.0)
Requirement already satisfied: threadpoolctl>=2.0.0 in /home/statkclee/.local/lib/python3.10/site-packages (from scikit_learn==1.2.1->-r requirements.txt (line 4)) (3.1.0)
Requirement already satisfied: six>=1.5 in /usr/lib/python3/dist-packages (from python-dateutil>=2.8.1->pandas==1.5.3->-r requirements.txt (line 3)) (1.16.0)

statkclee@dl:/mnt/d/tcs/curriculum/mlops/makefile$ make run
python3 penguins_pipeline.py
파이프라인 방식 정확도(Accuracy): 0.835820895522388

statkclee@dl:/mnt/d/tcs/curriculum/mlops/makefile$ ls
Makefile  penguins_pipeline.py  requirements.txt  results.txt
```

